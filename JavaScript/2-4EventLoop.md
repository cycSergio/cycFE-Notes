# 定时器

> [!NOTE]
>
> 1000毫秒 = 1毫秒。

定时器的作用是让代码在过了指定时间以后再执行（更准确的说法见下节）。JS中有两种定时器：`setTimeout()`和`setInterval()`。

- `setTimeout(回调函数，间隔的时间（毫秒）)`：由该方法开启的定时器可以由`clearTimeout(要关闭的定时器的name)` 来关闭。关闭了以后，被关闭定时器中的回调函数就不会再被执行了。
- `setInterval(回调函数，间隔的时间（毫秒）)`：和前者的区别在于，每个一个间隔时间，回调函数就会执行一次，除非你用`clearInterval(定时器的name)`关闭这个定时器。见下例：

```jsx
<h1 id="showNum"></h1>
const showNum = document.getElementById("showNum");
let num = 0;

const timer = setInterval(() => {
    num += 1;
    showNum.textContent = num;
    
    //达成某个条件时，关闭这个定时器
    if (num === 60) {
        clearInterval(timer);
    }
}, 1000);
```

在实际开发中，`setTimeout()`用得更多，原因见下节。

# 事件循环

事件循环图示[^1]：

<svg xmlns="http://www.w3.org/2000/svg" width="407" height="391" viewBox="0 0 407 391"><defs><style>@import url(https://fonts.googleapis.com/css?family=Open+Sans:bold,italic,bolditalic%7CPT+Mono);@font-face{font-family:&apos;PT Mono&apos;;font-weight:700;font-style:normal;src:local(&apos;PT MonoBold&apos;),url(/font/PTMonoBold.woff2) format(&apos;woff2&apos;),url(/font/PTMonoBold.woff) format(&apos;woff&apos;),url(/font/PTMonoBold.ttf) format(&apos;truetype&apos;)}</style></defs><g id="promise" fill="none" fill-rule="evenodd" stroke="none" stroke-width="1"><g id="eventLoop-full.svg"><text id="..." fill="#181717" font-family="PTMono-Regular, PT Mono" font-size="14" font-weight="normal"><tspan x="257.4" y="71">...</tspan></text><path id="Rectangle-1-Copy-6" fill="#FBF2EC" stroke="#DBAF88" stroke-width="2" d="M216 86h108v28H216z"/><path id="Rectangle-1-Copy-8" fill="#FBF2EC" stroke="#DBAF88" stroke-width="2" d="M216 195h108v28H216z"/><text id="mousemove" fill="#AF6E24" font-family="PTMono-Regular, PT Mono" font-size="14" font-weight="normal"><tspan x="232.2" y="214">mousemove</tspan></text><path id="Rectangle-1-Copy-9" fill="#FBF2EC" stroke="#DBAF88" stroke-width="2" d="M216 302h108v28H216z"/><text id="event-loop" fill="#181717" font-family="OpenSans-Regular, Open Sans" font-size="24" font-weight="normal"><tspan x="44.922" y="189">event</tspan> <tspan x="51.115" y="222">loop</tspan></text><text id="render-copy-2" fill="#181717" font-family="PTMono-Regular, PT Mono" font-size="14" font-weight="normal"><tspan x="297.3" y="176">render</tspan></text><g id="np_paint_2296353_000000-copy-2" fill="#C06334" fill-rule="nonzero" transform="translate(256 158)"><path id="Shape" d="M3.079 0A3.095 3.095 0 000 3.079V22.92A3.095 3.095 0 003.079 26H22.92A3.095 3.095 0 0026 22.921V3.08A3.095 3.095 0 0022.921 0H3.08zm0 2.053H22.92c.587 0 1.026.44 1.026 1.026v13.043l-2.886-2.684a1.027 1.027 0 00-1.443.032l-5.72 5.955-5.035-4.148a1.021 1.021 0 00-1.38.075l-5.43 5.43V3.08c0-.587.44-1.026 1.026-1.026zM6.158 3.42A3.095 3.095 0 003.078 6.5a3.095 3.095 0 003.08 3.079A3.095 3.095 0 009.237 6.5a3.095 3.095 0 00-3.08-3.079zm0 2.053c.579 0 1.026.447 1.026 1.026s-.447 1.026-1.026 1.026A1.012 1.012 0 015.132 6.5c0-.579.447-1.026 1.026-1.026zm14.176.566c-.377 0-.759.722-.759 1.08-.46.112-.748.358-.748.716s.371.717.748.717h2.662c.73 0 1.11-1.433-.021-1.433-.022-.677-.445-.86-1.134-.716-.183-.284-.375-.386-.748-.364zM16.71 9.237c-.314 0-.631.584-.631.876-.382.093-.63.296-.63.588 0 .293.316.589.63.589h2.213c.608 0 .931-1.176-.01-1.176-.018-.555-.379-.706-.952-.588-.152-.232-.31-.308-.62-.29zm3.688 6.382l3.55 3.293v4.01c0 .586-.44 1.025-1.027 1.025H3.08a1.01 1.01 0 01-.855-.449l6.05-6.04 4.202 3.453-1.24 1.294 1.475 1.422 7.687-8.008z"/></g><text id="microtasks-copy-2" fill="#181717" font-family="PTMono-Regular, PT Mono" font-size="14" font-weight="normal"><tspan x="297.5" y="140">microtasks</tspan></text><g id="Group-Copy-2" fill="#C06334" transform="translate(256 124)"><path id="Fill-52" d="M23.145.978C21.737.348 20.186 0 18.56 0c-2.59 0-4.983.885-6.921 2.38L10.474.618a.286.286 0 00-.305-.125.303.303 0 00-.226.249L8.797 7.779a.317.317 0 00.07.258.287.287 0 00.22.102h.018l3.112-.206 3.504-.233a.296.296 0 00.258-.204.315.315 0 00-.078-.33l-1.46-1.415a7.18 7.18 0 014.118-1.301c1.07 0 2.083.238 3.003.662a.284.284 0 00.23.003.306.306 0 00.162-.171l1.35-3.568a.314.314 0 00-.159-.398" transform="matrix(-1 0 0 1 32.117 0)"/><path id="Fill-54" d="M12.787 13.315a12.66 12.66 0 001.346 4.7c1.225 2.393 3.101 4.186 5.274 5.27l-.929 1.908a.318.318 0 00.04.342c.077.094.201.13.315.09l6.454-2.269a.3.3 0 00.183-.187.32.32 0 00-.018-.251l-.01-.016-1.644-2.779-1.852-3.127a.29.29 0 00-.295-.142.298.298 0 00-.24.228l-.498 2.018a7.607 7.607 0 01-3.041-3.19 8.083 8.083 0 01-.865-3.087.314.314 0 00-.105-.214.286.286 0 00-.22-.068l-3.636.44a.305.305 0 00-.26.334" transform="matrix(-1 0 0 1 38.273 0)"/><path id="Fill-56" d="M2.646 22.333a12.003 12.003 0 003.205-3.576 12.684 12.684 0 001.713-7.424l2.04-.112a.293.293 0 00.262-.207.316.316 0 00-.084-.332L4.681 5.958a.28.28 0 00-.247-.072.291.291 0 00-.198.14l-.01.018-1.47 2.883-1.654 3.247a.32.32 0 00.03.339.285.285 0 00.307.104l1.916-.558a8.078 8.078 0 01-1.111 4.358 7.652 7.652 0 01-2.117 2.33.31.31 0 00-.123.203.325.325 0 00.053.234l2.183 3.08a.285.285 0 00.406.069" transform="matrix(-1 0 0 1 9.882 0)"/></g><text id="render-copy-2" fill="#181717" font-family="PTMono-Regular, PT Mono" font-size="14" font-weight="normal"><tspan x="297.3" y="285">render</tspan></text><g id="np_paint_2296353_000000-copy-2" fill="#C06334" fill-rule="nonzero" transform="translate(256 267)"><path id="Shape" d="M3.079 0A3.095 3.095 0 000 3.079V22.92A3.095 3.095 0 003.079 26H22.92A3.095 3.095 0 0026 22.921V3.08A3.095 3.095 0 0022.921 0H3.08zm0 2.053H22.92c.587 0 1.026.44 1.026 1.026v13.043l-2.886-2.684a1.027 1.027 0 00-1.443.032l-5.72 5.955-5.035-4.148a1.021 1.021 0 00-1.38.075l-5.43 5.43V3.08c0-.587.44-1.026 1.026-1.026zM6.158 3.42A3.095 3.095 0 003.078 6.5a3.095 3.095 0 003.08 3.079A3.095 3.095 0 009.237 6.5a3.095 3.095 0 00-3.08-3.079zm0 2.053c.579 0 1.026.447 1.026 1.026s-.447 1.026-1.026 1.026A1.012 1.012 0 015.132 6.5c0-.579.447-1.026 1.026-1.026zm14.176.566c-.377 0-.759.722-.759 1.08-.46.112-.748.358-.748.716s.371.717.748.717h2.662c.73 0 1.11-1.433-.021-1.433-.022-.677-.445-.86-1.134-.716-.183-.284-.375-.386-.748-.364zM16.71 9.237c-.314 0-.631.584-.631.876-.382.093-.63.296-.63.588 0 .293.316.589.63.589h2.213c.608 0 .931-1.176-.01-1.176-.018-.555-.379-.706-.952-.588-.152-.232-.31-.308-.62-.29zm3.688 6.382l3.55 3.293v4.01c0 .586-.44 1.025-1.027 1.025H3.08a1.01 1.01 0 01-.855-.449l6.05-6.04 4.202 3.453-1.24 1.294 1.475 1.422 7.687-8.008z"/></g><text id="microtasks-copy-2" fill="#181717" font-family="PTMono-Regular, PT Mono" font-size="14" font-weight="normal"><tspan x="297.5" y="249">microtasks</tspan></text><g id="Group-Copy-2" fill="#C06334" transform="translate(256 233)"><path id="Fill-52" d="M23.145.978C21.737.348 20.186 0 18.56 0c-2.59 0-4.983.885-6.921 2.38L10.474.618a.286.286 0 00-.305-.125.303.303 0 00-.226.249L8.797 7.779a.317.317 0 00.07.258.287.287 0 00.22.102h.018l3.112-.206 3.504-.233a.296.296 0 00.258-.204.315.315 0 00-.078-.33l-1.46-1.415a7.18 7.18 0 014.118-1.301c1.07 0 2.083.238 3.003.662a.284.284 0 00.23.003.306.306 0 00.162-.171l1.35-3.568a.314.314 0 00-.159-.398" transform="matrix(-1 0 0 1 32.117 0)"/><path id="Fill-54" d="M12.787 13.315a12.66 12.66 0 001.346 4.7c1.225 2.393 3.101 4.186 5.274 5.27l-.929 1.908a.318.318 0 00.04.342c.077.094.201.13.315.09l6.454-2.269a.3.3 0 00.183-.187.32.32 0 00-.018-.251l-.01-.016-1.644-2.779-1.852-3.127a.29.29 0 00-.295-.142.298.298 0 00-.24.228l-.498 2.018a7.607 7.607 0 01-3.041-3.19 8.083 8.083 0 01-.865-3.087.314.314 0 00-.105-.214.286.286 0 00-.22-.068l-3.636.44a.305.305 0 00-.26.334" transform="matrix(-1 0 0 1 38.273 0)"/><path id="Fill-56" d="M2.646 22.333a12.003 12.003 0 003.205-3.576 12.684 12.684 0 001.713-7.424l2.04-.112a.293.293 0 00.262-.207.316.316 0 00-.084-.332L4.681 5.958a.28.28 0 00-.247-.072.291.291 0 00-.198.14l-.01.018-1.47 2.883-1.654 3.247a.32.32 0 00.03.339.285.285 0 00.307.104l1.916-.558a8.078 8.078 0 01-1.111 4.358 7.652 7.652 0 01-2.117 2.33.31.31 0 00-.123.203.325.325 0 00.053.234l2.183 3.08a.285.285 0 00.406.069" transform="matrix(-1 0 0 1 9.882 0)"/></g><path id="Path" fill="#C06334" fill-rule="nonzero" d="M240.536 23.5c18.067 0 28.19 5.407 30.493 19.865l.067.441.016.179.264 10.223 5.906-11.165 2.652 1.402-8.582 16.229-1.247 2.357-1.367-2.29-9.412-15.76 2.576-1.539 6.476 10.845-.263-10.128-.046-.305c-1.998-12.562-10.586-17.259-27.028-17.353l-.505-.001h-51.072c-18.854 0-27.785 5.925-27.961 22.709l-.003.512v294.675c0 9.183 2.661 14.683 7.881 17.703 4.3 2.487 10.047 3.365 19.488 3.4l.595.001h51.072c9.796 0 15.693-.862 20.083-3.401 5.127-2.966 7.785-8.324 7.878-17.214l.003-.489v-6.472h3v6.472c0 10.183-3.152 16.697-9.379 20.3-4.884 2.825-11.037 3.766-20.972 3.803l-.613.001h-51.072c-10.296 0-16.602-.921-21.585-3.804-6.122-3.542-9.271-9.897-9.376-19.785l-.003-.515V49.721c0-18.944 10.246-26.078 30.352-26.219l.612-.002h51.072z"/><text id="script" fill="#AF6E24" font-family="PTMono-Regular, PT Mono" font-size="14" font-weight="normal"><tspan x="245.3" y="105">script</tspan></text><text id="setTimeout" fill="#AF6E24" font-family="PTMono-Regular, PT Mono" font-size="14" font-weight="normal"><tspan x="228.5" y="321">setTimeout</tspan></text></g></g></svg>

JS是单线程的，浏览器中JS脚本 的执行流程和 Node.js 中的流程都是基于**事件循环机制（event loop）**。

- 调用栈（后进先出）：调用栈中放的是正在执行的任务（未执行完的函数的上下文）
- 任务队列（先进先出）：任务队列中的是将要执行的异步任务。当调用栈中的代码执行完毕后，任务队列中的代码才会按照顺序依次进入到栈中执行。在JS中，任务队列**有两种**：

  - 宏任务队列（大部分代码都来宏任务队列中排队）
  - 微任务队列（Promise的then\catch\finally）


①JS引擎首先执行全局代码，并将其中的**同步任务**按照顺序放入**调用栈**。当遇到异步任务时，JS引擎会将其回调函放入相应的消息队列中。

②当执行栈为空时，事件循环开始工作：事件循环首先检查**微任务**队列，如果不为空，会将所有微任务依次放入调用栈中执行，直到微任务队列为空。

③接下来，事件循环从宏任务队列中取出第一个任务放入调用栈中执行。执行完该任务后，再次检查微任务队列，并执行其中的微任务（如果有）。

④这个过程循环进行，不断从宏任务队列中取出任务执行，然后执行微任务，直到任务队列和微任务队列都为空。

## 1. 调用栈

函数在每次被执行时，都会产生一个**执行上下文**（执行环境）。执行上下文负责存储函数执行时产生的一切数据，包括局部变量、`this`等。这个执行环境是存储在调用栈上的。   

**调用栈（call stack）**：一块内存区域，负责存储函数的执行环境。当一个函数被调用时，其执行环境会作为一个栈帧被插入到调用栈的栈顶。在执行脚本时，栈底的那个帧是全局作用域的执行环境；栈顶（栈的最上面）就是当前正在执行的函数。当函数执行完毕，其栈帧会被从栈中弹出。JS是单线程的，调用栈也是单线程的，即一次只能执行一个任务。

## 2. 消息队列

```jsx
<button id='btn'>我是button</button>
const btn = document.getElementById("btn");
btn.onclick = function(){
    console.log("button被点了一下")
}
```

line3处的回调函数，是在事件触发之后才会被执行。它执行的时候，调用栈上完全可能是空的（意味着脚本已经完全执行完了），那么我们点了按钮之后，调用栈上会发生什么？会出现一个`btn.onclick`的执行环境呀。此处的关键在于，`btn.onclick`的执行环境是怎么出现在调用栈上的？本来调用栈已经空了呢。

**消息队列（event queue）**：负责存储将要执行的函数。当我们触发一个事件时，其响应函数并不是直接立即添加到了调用栈中，因为此时调用栈可能还由一些正在执行的代码。事件触发后，JS引擎是将事件的响应函数插入到消息队列中。消息队列中的任务可以是异步回调函数、Promise 回调函数、定时器回调函数、事件处理函数等。

一个调用栈被阻塞、消息队列需要等待的例子，可以去浏览器调式看看：

```jsx
console.time()
setTimeout(function(){
    console.timeEnd()
    console.log("定时器执行啦")
}, 3000)

//使程序卡5s
const begin = Date.now();
while (Date.now() - begin < 5000) {}
```

## 3. 再看定时器

事实上，定时器的本质是，在间隔指定时间以后，将回调函数添加到消息队列中！而到底在什么时候这个回调函数会被执行，要看调用栈中具体的情况。

到此为止，我们也就可以明白`setInterval()`的缺点是什么：它每隔一段时间就将回调函数添加到消息队列中，但是如果函数执行的速度比较慢（反正就是调用栈被阻塞了），它是无法确保每次执行的间隔都是一样的。

我们希望可以确保函数每次执行都有相同的间隔，间隔可以更大，但是不要小。那还是得用`setTimeout()`：

```javascript
setTimeout(function fn() {
    console.log("执行回调")
    //在setTimeout的回调函数执行完后，再调用一个setTimeout
    setTimeout(fn, 3000)
}, 3000)
```

在上面的代码里，我的回调函数每次执行完之后，就再给它挂上一个定时器，嘿嘿。这样一来，由于定时器都是在回调执行完毕之后才添加的，可以确保这个回调函数每次执行之间的间隔是确定的。至少不会小于我们想要设置的间隔时间，大于的情况无法掌控，因为可能有别的东西阻塞了它。

# 总结一下 & 小quiz

调用栈用于跟踪函数调用和执行上下文，消息队列用于存储待执行的异步任务。JavaScript 引擎通过事件循环机制从消息队列中获取任务并执行，从而实现异步编程。

判断下列代码的执行顺序：

先看非常简单的一题:

```javascript
setTimeout(() => {
    console.log(1)
});

console.log(2);
//2
//1
```

在看看这个：

```javascript
setTimeout(() => {console.log(1)}, 0) //定时器的作用是间隔xxx ms后，将函数放入到任务队列中

Promise.resolve(1).then(() => {
    console.log(2)
})

console.log(3) //全局作用域里的代码肯定一上来就在调用栈里面。但是函数里面的代码，并不是在全局作用域中哦
//3
//2
//1
```

在JS中，还可以用`queueMicrotask()`来向微任务队列中添加一个任务：

```javascript
queueMicrotask(() => {
    console.log(1)
})
```

再来看一个有些绕的顺序题：

```javascript
Promise.resolve().then(() => {
    setTimeout(() => {
        console.log(1)
    })
})

queueMicrotask(() => {
    console.log(2)
})
//2
//1
```

再来看一到顺序题：

```javascript
Promise.resolve().then(() => {
    Promise.resolve().then(() => {
        console.log(1)
    })
})

queueMicrotask(() => {
    console.log(2)
})
//2
//1
```

都不是很复杂捏，搞清楚流程想一下为什么要这样设计就好了。

**参考**：

[^1]: https://zh.javascript.info/event-loop

